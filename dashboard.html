<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Mabe Monitor | Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config={darkMode:'class'}</script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen flex flex-col">
<header class="bg-blue-800 text-white p-4 flex justify-between">
  <div class="flex items-center"><div class="bg-white text-blue-800 w-10 h-10 flex items-center justify-center rounded-full font-bold">M</div><span class="ml-2 text-xl">Mabe Monitor</span></div>
  <div><p id="user-info"></p><button id="logoutBtn" class="bg-red-500 px-3 py-1 rounded">Logout</button></div>
</header>
<main class="flex-grow p-4 container mx-auto">
  <section id="user-controls" class="mt-4">
    <button id="clockInBtn" class="bg-green-600 px-3 py-1 rounded text-white">Clock In</button>
    <button id="clockOutBtn" class="bg-red-600 px-3 py-1 rounded text-white">Clock Out</button>
    <button id="toggleTheme" class="ml-4 bg-gray-300 dark:bg-gray-700 px-3 py-1 rounded">Toggle Theme</button>
  </section>
  <section class="mt-8">
    <h2 class="text-xl">Employee List</h2>
    <div id="status-msg" class="my-2 text-green-600"></div>
    <ul id="employee-list" class="space-y-2"></ul>
  </section>
  <section id="add-employee-section" class="mt-8 hidden bg-white dark:bg-gray-800 rounded p-4 shadow">
    <h3 class="text-lg mb-2">Add Employee</h3>
    <form id="add-employee-form" class="space-y-2">
      <input name="name" placeholder="Full Name" class="w-full p-2 border rounded" required />
      <input name="email" type="email" placeholder="Email" class="w-full p-2 border rounded" required />
      <input name="password" type="password" placeholder="Password" class="w-full p-2 border rounded" required />
      <select name="role" class="w-full p-2 border rounded">
        <option value="employee">Employee</option>
        <option value="admin">Admin</option>
      </select>
      <button type="submit" class="w-full bg-blue-600 text-white p-2 rounded">Add</button>
    </form>
    <div id="add-result" class="mt-2 text-green-600"></div>
  </section>
</main>
<footer class="bg-gray-200 dark:bg-gray-800 text-center py-2 text-sm">
  © 2025 Cambridge Mabe | Mabe Group
</footer>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
  const BACKEND = 'http://localhost:3000'; // same URL as index!
  const socket = io(BACKEND);
  const user = JSON.parse(localStorage.getItem('user')||'null');
  if(!user){alert('Not logged in');location='/index.html';}
  document.getElementById('user-info').textContent = `${user.name} (${user.role})`;
  if(user.role==='admin') document.getElementById('add-employee-section').classList.remove('hidden');
  document.getElementById('toggleTheme').onclick = () => document.documentElement.classList.toggle('dark');
  document.getElementById('logoutBtn').onclick = async () => {
    await fetch(`${BACKEND}/clockout/${user.email}`,{method:'POST'});
    socket.emit('logout',user.email);
    localStorage.removeItem('user');
    location='/index.html';
  };
  document.getElementById('clockInBtn').onclick = async () => {
    await fetch(`${BACKEND}/login`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email:user.email,password:user.password})});
    socket.emit('login', user.email);
    loadEmployees();
  };
  document.getElementById('clockOutBtn').onclick = async () => {
    await fetch(`${BACKEND}/clockout/${user.email}`,{method:'POST'});
    socket.emit('logout', user.email);
    loadEmployees();
  };
  socket.on('userStatusUpdate', loadEmployees);
  async function loadEmployees(){
    const url = user.role==='admin'?`${BACKEND}/employees`:`${BACKEND}/employee/${user.email}`;
    const res = await fetch(url);
    const data = await res.json();
    const list = Array.isArray(data)?data:[data];
    document.getElementById('employee-list').innerHTML = list.map(emp =>`
      <li class="p-2 bg-white dark:bg-gray-800 rounded shadow">
        <div class="font-medium">${emp.name}</div><div>${emp.email}</div>
        <div>Status:
          <span class="inline-block px-2 ${(emp.status==='online'?'bg-green-500':'bg-red-500')} text-white rounded">${emp.status}</span>
        </div>
      </li>`).join('');
    if(user.role!=='admin'){
      const self=list[0];
      document.getElementById('status-msg').textContent = self.status==='online'?'✅ You are online':'';
    }
  }
  document.getElementById('add-employee-form').onsubmit = async e => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const obj = Object.fromEntries(fd);
    const res = await fetch(`${BACKEND}/add-employee`,{
      method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(obj)
    });
    const data = await res.json();
    document.getElementById('add-result').textContent = data.message;
    loadEmployees();
  };
  loadEmployees();
</script>
</body>
</html>
